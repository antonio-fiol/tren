<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!--<link rel="stylesheet" href="css/jquery-ui.css">-->
<link rel="stylesheet" href="css/jquery.mobile-1.4.5.min.css" />

<script type="text/javascript" src="js/jquery.min.js"></script>
<!--<script type="text/javascript" src="js/jquery-ui.min.js"></script>-->
<script type="text/javascript" src="js/jquery.mobile-1.4.5.min.js"></script>

<script type="text/javascript" src="js/jquery.svg.js"></script>
<script type="text/javascript" src="js/jquery.svgdom.js"></script>
<script type="text/javascript" src="js/svg.js"></script>
<script type="text/javascript" src="js/jquery.jqplot.min.js"></script>
<script type="text/javascript" src="js/jquery.minicolors.min.js"></script>

<link rel="stylesheet" href="css/jquery.minicolors.css">

<style type="text/css">
/* Vias sin tren son semitransparentes y negras */
[tren=none] {
  opacity: 0.3;
}
#layer3 > g {
  stroke: black;
}

/* Los trazos de las vias se colorean segun el tema */
.c1 .coloreado, g.c1 *, .c1 .invertir { stroke: #a00; fill: #a00; }
.c2 .coloreado, g.c2 *, .c2 .invertir { stroke: #00a; fill: #00a; }
.c3 .coloreado, g.c3 *, .c3 .invertir { stroke: #0a0; fill: #0a0; }
.c4 .coloreado, g.c4 *, .c4 .invertir { stroke: #aa0; fill: #aa0; }
.c5 .coloreado, g.c5 *, .c5 .invertir { stroke: #a0a; fill: #a0a; }
.c6 .coloreado, g.c6 *, .c6 .invertir { stroke: #0aa; fill: #0aa; }
/* Quitar tension provoca trazo discontinuo */
.stop path { stroke-dasharray: 10,10; }

/* Los controles tambien tienen color */
.control-tren .ui-slider-handle { background-image: none; }
.ajustado .ui-slider-handle,
.c1 .ui-slider-handle { background-color: #a00; }
.c2 .ui-slider-handle { background-color: #00a; }
.c3 .ui-slider-handle { background-color: #0a0; }
.c4 .ui-slider-handle { background-color: #aa0; }
.c5 .ui-slider-handle { background-color: #a0a; }
.c6 .ui-slider-handle { background-color: #0aa; }
.ajustado input, .ajustado .coloreado, 
.c1 input, .c1 .coloreado { color: #a00; }
.c2 input, .c2 .coloreado { color: #00a; }
.c3 input, .c3 .coloreado { color: #0a0; }
.c4 input, .c4 .coloreado { color: #aa0; }
.c5 input, .c5 .coloreado { color: #a0a; }
.c6 input, .c6 .coloreado { color: #0aa; }

/* Los agarres son visibles solo cuando hay tren */
g .circuloyflecha {
  display:none;
}
#layer3 > g[idtren] .circuloyflecha {
  opacity: 0.3;
  display: initial;
}

/* Avisos de que el estado del tren no es el adecuado */
#layer3 > g .accesorios polygon {
  display: none;
}
#layer3 > g[estado="1"] .accesorios polygon {
  display:initial;
  fill:yellow;
}
#layer3 > g[estado="2"] .accesorios polygon,
#layer3 > g[estado="7"] .accesorios polygon {
  display:initial;
  fill:red;
}
#layer3 > g[estado="7"] .accesorios polygon {
  transform: scale(2);
}
#layer3 > g[estado="3"] .accesorios polygon {
  display:initial;
  fill:red;
}
#layer3 > g[estado="4"] .accesorios polygon {
  display:initial;
  fill:yellow;
}
#layer3 > g[estado="5"] .accesorios polygon {
  display:initial;
  fill:red;
  stroke:yellow;
  stroke-width: 2;
  transform: scale(2);
}
#layer3 > g[estado="5"] .circuloyflecha {
  stroke: red;
  fill: red;
  opacity: 1;
}
#layer3 > g[invertido="true"] .circuloyflecha {
  transform: rotate(180deg);
}
#layer3 > g > text.idVia {
    opacity: .9;
    stroke-opacity: 0;
    font-size: 12px;
}
#layer3 > g:hover > text.idVia {
    opacity: 1;
    stroke-opacity: 1;
}
#layer1 > g > text.idDesvio {
    fill: white;
    font-size: 40px;
    text-anchor: middle;
    opacity: .5;
    dominant-baseline: central;
}
#layer1 > g:hover > text.idDesvio {
    opacity: .9;
}
.id {
  display:inline-block;
  text-align: center;
  width: 2.5em;
}
.control-tren .id {
  background-image: url('estaciones.svg');
  background-position: center bottom;
  background-repeat: no-repeat;
  height: 2em;
}
.velocidad {
  width: 20em;
  margin-left: 0.1em;
  margin-right: 0.5em;
}
.quitado {
  width: 2em;
  background: yellow;
  border: 0.2em solid red;
}
.izquierda,
.derecha {
  min-width: 27em;
  max-width: 35em;
  border: 1px solid #888;
  display: inline-block;
  vertical-align: top;
}
.control {
  margin-left: 1em;
  margin-right: 1em;
}
#antipopup .control {
  margin-left: 0.5em;
  margin-right: 0.5em;
}
.control > form > * {
  vertical-align: middle;
  display: inline-block;
}
/*.control-via.stop {
  background-color: #ffa;
}*/
form {
  margin-bottom: 0;
}
input[type="number"] {
  text-align: right;
}
input[type="number"].ui-slider-input {
  width: 3em;
}
.ui-slider-track {
  margin-left: 4em;
}
#content {
  position:relative;
}
#processing {
  position:absolute;
  top:0;
  right:0;
  width: 20px;
  height: 20px;
  border: 1px solid #888;
}
#antipopup {
    background-color: rgba(0, 0, 0, 0.1);
    margin-right: 170px;
    height: 106px;
}
.popup {
   display:inline-block;
   text-align: center;
}
/* Ocultar velocimetro, mostrar controles iniciales, para tren nuevo */
.boton-tren.nuevo .setup { display: block; }
.boton-tren.nuevo .velocimetro { display: none; }
.setup {
   width: 125px;
   height: 120px;
   text-align: left;
   display: none;
}
.setup .invertir, .setup .control_manual, .setup .volver {
   text-align: center;
   display: inline-block;
   vertical-align: top;
}
.setup .volver {
   float:right;
}
.setup .id {
   margin-bottom: -7px;
}
#parametros fieldset, #tiras fieldset {
   border-width: 1px;
   border-color: rgba(255,255,255,0.5);
   margin-left: 0.5em;
   margin-right: 0.5em;
   margin-bottom: 0.5em;
   padding-bottom: 0.5em;
   padding-top: 0.5em;
}
legend {
   font-size: x-large;
   padding-left: 0.5em;
   margin-left: 0.5em;
   padding-right: 0.5em;
}
#parametros legend:before {
   content: '- ';
}
#parametros .colapsado legend:before {
   content: '+ ';
}
.parametro {
   margin: 0.5em;
   margin-top: 1em;
}
.parametro label {
   margin-bottom: 0;
}
.parametro .doc {
   margin-top: 0;
   padding-left: 2em;
   padding-right: 2em;
   font-size: smaller;
}
.colapsado .parametro {
   display:none;
}
.ui-state-disabled {
    opacity: 0.5;
}
.ui-state-disabled div.ui-slider {
    height: 12px;
}

.ui-slider-track.ui-state-disabled {
    height: 1px;
}
.ui-state-disabled .ui-slider-track .ui-btn.ui-slider-handle {
    height: 10px;
    margin-top: -7px
}
.ui-state-disabled input {
    min-height: initial;
    padding-top: 0;
}
/*
#master-controls {
  position:absolute;
  bottom:0;
  right:0;
  background-color: rgba(255,255,255,0.5);
  padding: 0.5em;
}
*/

#container {
    margin-right: -150px;
    float:left;
    width:100%;
    height:100%;
}
#svgbasics {
    margin-right: 170px; /* 20px added for center margin */
}
#master-controls {
    width:150px;
    float:left;
}
#master-left {
    float: left;
    width: 58px;
    margin: 5px;
}
#master-left>* {
    margin: 5px;
}
#master-left #play {
    margin-left: 0;
    margin-right: 0;
}
#master-left #stop {
    margin-right: 0;
}
#feedly-mini-banner {
  display: none;
}
.boton-tren {
  display:inline-block;
  position:relative;
  margin-right: 0.5em;
}
/*
.boton-tren .id {
    position: absolute;
    top: 0;
    color: white;
    text-align: center;
    display: block;
    padding-top: 8px;
}
.boton-tren .clase {
    width: 2.5em;
    overflow: hidden;
}
*/
.grafica {
    width: 27em;
}
.estaciones h4 {
    /* border-top: 1px solid white; */
    padding-top: 0.5em;
    margin: 0;
    font-weight: normal;
}
.estaciones .activas,
.estaciones .todas {
    min-height: 4.5em;
    padding-bottom: 0.4em;
}
.estacion {
    display: inline-block;
    width: 6em;
    height: 4em;
    border: 1px solid #555;
    position: relative;
    background-position: center;
}
.estacion .action {
    position: absolute;
    width: 50%;
    height: 4em;
    bottom: 0;
}
.invertir {
}
.activas .estacion {
    width: 4em;
}
.todas .estacion .action.left {
    left: 0;
    background: url('ccw-512px-c.svg') bottom left no-repeat;
    background-size: 2em;
}
.todas .estacion .action.right {
    right: 0;
    background: url('cw-512px-c.svg') bottom right no-repeat;
    background-size: 2em;
}
.activas .estacion .action.right {
    right: 0;
    background: url('menos.svg') bottom right no-repeat;
    background-size: 2em;
}
.activas .estacion.cw .action.left {
    background: url('cw-512px.svg') bottom left no-repeat;
    background-size: 2em;
}
.activas .estacion.ccw .action.left {
    background: url('ccw-512px.svg') bottom left no-repeat;
    background-size: 2em;
}
.control_manual {
  background: url('mano.svg') center no-repeat;
}
.control_manual .action {
    width:30px; height:30px;
    display: inline-block;
    font-size: 20px;
}
.control_manual .action.f {
  cursor: e-resize;
}
.control_manual .action.r {
  cursor: w-resize;
}
.auto .action {
    margin-bottom:1ex;
    border: 1px solid transparent;
    border-radius: 1em;
}
.auto .action.active {
    border-color: black;
}
.alinear_vertical>* {
    margin-bottom:1ex;
}
.estacion.st1 { background-image: url('estacion1-128.jpg'); }
.estacion.st2 { background-image: url('estacion2-128.jpg'); }
.estacion.st1e { background-image: url('estacion3-128.jpg'); }

.sonidos ul {
    background: url('volume-24.svg') no-repeat top center;
    padding-left: 0;
    padding-top: 24;
    list-style-type: none;
}
input.color {
    min-height: 2em;
}
/* Acciones, desvios, semaforos, luces, vias con tren */
.action, #layer1, #layer5, #layer8, #layer3>g[estado] {
    cursor: pointer;
}
g.velocidad-input {
    cursor: crosshair;
}
.boton_opciones, .boton_opciones-weather {
    position: relative;
}
.opciones, .opciones-weather {
    position: absolute;
    width: 500px;
    padding-top: 10px;
    padding-left: 10px;
    padding-right: 10px;
    z-index: 1;
}
.opciones {
    left: -54px;
    background: url(popup.svg);
}
.opciones-weather {
    left: -9px;
    background: url(popup-left.svg);
}
.opciones .SonidoTren {
    background: url(ic_volume_up_black_24px.svg) no-repeat;
    background-size: contain;
    padding-left: 24px;
}
.opciones .cuando {
    margin-left: 1em;
}
.opciones .EventoTrenArrancando, .opciones .EventoTrenParado,
.opciones .EventoEntraTren, .opciones .EventoSaleTren {
    background-image: url(ic_arrow_forward_black_24px.svg);
    background-repeat: no-repeat;
    background-size: contain;
}
.opciones .EventoEntraTren, .opciones .EventoSaleTren {
    border: 1px dashed;
}
.opciones .EventoTrenArrancando, .opciones .EventoTrenParado {
    border: 1px solid;
}
.opciones .EventoTrenArrancando {
    border-top-right-radius: .5em;
}
.opciones .EventoTrenParado {
    border-top-left-radius: .5em;
}
.opciones .EventoEntraTren, .opciones .EventoTrenParado {
    padding-right: 0.5em;
    padding-left: 1em;
}
.opciones .EventoSaleTren, .opciones .EventoTrenArrancando {
    padding-right: 1em;
    padding-left: 0.5em;
    background-position: right;
}
.opciones .EventoVelocidadCero {
    background: url(speed_zero.svg);
    background-repeat: no-repeat;
    background-size: contain;
    width: 48px;
    height: 15px;
    display: inline-block;
}
.ui-radio-on path, .ui-checkbox-on path {
    fill: white;
}

@media (max-width: 1024px) {
  #antipopup {
    height: 212px;
  }
  .estaciones.disponibles {
    display: block;
  }
}
@media (max-width: 750px) {
  #antipopup {
    height: 318px;
  }
}
@media (max-width: 600px) {
  #master-controls {
    float: none;
  }
  #antipopup, #svgbasics {
    margin-right: 0;
  }
}
</style>
</head>
<body>
  <div id="content" style="">
    <div id="processing" style=""><div id="barcontainer" style="position:relative; width: 100%; height:100%;"><div id="bar" style="position: absolute; width:100%; background-color: yellow; opacity: .3; height: 0; bottom: 0;"></div></div></div>
    <div id="container">
      <div id="master-left">
        <span id="quitar-tension" title="Quitar tension">
          <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
            <path d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42C17.99 7.86 19 9.81 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-2.19 1.01-4.14 2.58-5.42L6.17 5.17C4.23 6.82 3 9.26 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.74-1.23-5.18-3.17-6.83z"/>
          </svg>
        </span>
        <span id="stop" title="Velocidades a cero"><svg height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" class="pausa" />
          <path d="M6 6h12v12H6z" class="stop" style="display:none;" />
        </svg></span>
        <span id="play" title="Restaurar velocidades" style="display:none;"><svg height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
          <path d="M8 5v14l11-7z" />
        </svg></span>
        <div class="boton_opciones-weather">
         <svg class="action" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg" onclick="$(this).nextAll('.opciones-weather').toggle();">
            <path d="M12.74,5.47C15.1,6.5 16.35,9.03 15.92,11.46C17.19,12.56 18,14.19 18,16V16.17C18.31,16.06 18.65,16 19,16A3,3 0 0,1 22,19A3,3 0 0,1 19,22H6A4,4 0 0,1 2,18A4,4 0 0,1 6,14H6.27C5,12.45 4.6,10.24 5.5,8.26C6.72,5.5 9.97,4.24 12.74,5.47M11.93,7.3C10.16,6.5 8.09,7.31 7.31,9.07C6.85,10.09 6.93,11.22 7.41,12.13C8.5,10.83 10.16,10 12,10C12.7,10 13.38,10.12 14,10.34C13.94,9.06 13.18,7.86 11.93,7.3M13.55,3.64C13,3.4 12.45,3.23 11.88,3.12L14.37,1.82L15.27,4.71C14.76,4.29 14.19,3.93 13.55,3.64M6.09,4.44C5.6,4.79 5.17,5.19 4.8,5.63L4.91,2.82L7.87,3.5C7.25,3.71 6.65,4.03 6.09,4.44M18,9.71C17.91,9.12 17.78,8.55 17.59,8L19.97,9.5L17.92,11.73C18.03,11.08 18.05,10.4 18,9.71M3.04,11.3C3.11,11.9 3.24,12.47 3.43,13L1.06,11.5L3.1,9.28C3,9.93 2.97,10.61 3.04,11.3M19,18H16V16A4,4 0 0,0 12,12A4,4 0 0,0 8,16H6A2,2 0 0,0 4,18A2,2 0 0,0 6,20H19A1,1 0 0,0 20,19A1,1 0 0,0 19,18Z" />
         </svg>
         <div class="opciones-weather" style="display:none;">
           <form>
             <fieldset data-role="controlgroup" data-type="horizontal">
               <legend>Tiempo:</legend>
               <input type="radio" name="weather" id="weather-off" value="off">
               <label for="weather-off"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="24" height="24" viewBox="0 0 24 24"><path d="M16.56,5.44L15.11,6.89C16.84,7.94 18,9.83 18,12A6,6 0 0,1 12,18A6,6 0 0,1 6,12C6,9.83 7.16,7.94 8.88,6.88L7.44,5.44C5.36,6.88 4,9.28 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12C20,9.28 18.64,6.88 16.56,5.44M13,3H11V13H13" /></svg></label>
               <input type="radio" name="weather" id="weather-blanco" value="blanco">
               <label for="weather-blanco"><svg height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6C7.8 12.16 7 10.63 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z"/><path
     d="m 10.067797,14.810124 0,-1.155978 -0.4322038,-0.285495 C 7.9888934,12.280911 7.0921211,10.746512 7.0848798,9.00432 7.0717645,5.8489489 10.140923,3.4357699 13.165266,4.2235111 c 3.201644,0.8339225 4.710299,4.3533957 3.096713,7.2241849 -0.314986,0.560405 -1.21093,1.467388 -1.897572,1.920955 l -0.432204,0.285495 0,1.155978 0,1.155978 -1.932203,0 -1.932203,0 0,-1.155978 z" style="fill:white;stroke:white;stroke-width:0.5;" /></svg></label>
               <input type="radio" name="weather" id="weather-sunny" value="sunny">
               <label for="weather-sunny"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="24" height="24" viewBox="0 0 24 24"><path d="M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,2L14.39,5.42C13.65,5.15 12.84,5 12,5C11.16,5 10.35,5.15 9.61,5.42L12,2M3.34,7L7.5,6.65C6.9,7.16 6.36,7.78 5.94,8.5C5.5,9.24 5.25,10 5.11,10.79L3.34,7M3.36,17L5.12,13.23C5.26,14 5.53,14.78 5.95,15.5C6.37,16.24 6.91,16.86 7.5,17.37L3.36,17M20.65,7L18.88,10.79C18.74,10 18.47,9.23 18.05,8.5C17.63,7.78 17.1,7.15 16.5,6.64L20.65,7M20.64,17L16.5,17.36C17.09,16.85 17.62,16.22 18.04,15.5C18.46,14.77 18.73,14 18.87,13.21L20.64,17M12,22L9.59,18.56C10.33,18.83 11.14,19 12,19C12.82,19 13.63,18.83 14.37,18.56L12,22Z" /></svg></label>
               <input type="radio" name="weather" id="weather-cloudy" value="cloudy">
               <label for="weather-cloudy"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="24" height="24" viewBox="0 0 24 24"><path d="M6,19A5,5 0 0,1 1,14A5,5 0 0,1 6,9C7,6.65 9.3,5 12,5C15.43,5 18.24,7.66 18.5,11.03L19,11A4,4 0 0,1 23,15A4,4 0 0,1 19,19H6M19,13H17V12A5,5 0 0,0 12,7C9.5,7 7.45,8.82 7.06,11.19C6.73,11.07 6.37,11 6,11A3,3 0 0,0 3,14A3,3 0 0,0 6,17H19A2,2 0 0,0 21,15A2,2 0 0,0 19,13Z" /></svg></label>
               <input type="radio" name="weather" id="weather-rainy" value="rainy">
               <label for="weather-rainy"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="24" height="24" viewBox="0 0 24 24"><path d="M9,12C9.53,12.14 9.85,12.69 9.71,13.22L8.41,18.05C8.27,18.59 7.72,18.9 7.19,18.76C6.65,18.62 6.34,18.07 6.5,17.54L7.78,12.71C7.92,12.17 8.47,11.86 9,12M13,12C13.53,12.14 13.85,12.69 13.71,13.22L11.64,20.95C11.5,21.5 10.95,21.8 10.41,21.66C9.88,21.5 9.56,20.97 9.7,20.43L11.78,12.71C11.92,12.17 12.47,11.86 13,12M17,12C17.53,12.14 17.85,12.69 17.71,13.22L16.41,18.05C16.27,18.59 15.72,18.9 15.19,18.76C14.65,18.62 14.34,18.07 14.5,17.54L15.78,12.71C15.92,12.17 16.47,11.86 17,12M17,10V9A5,5 0 0,0 12,4C9.5,4 7.45,5.82 7.06,8.19C6.73,8.07 6.37,8 6,8A3,3 0 0,0 3,11C3,12.11 3.6,13.08 4.5,13.6V13.59C5,13.87 5.14,14.5 4.87,14.96C4.59,15.43 4,15.6 3.5,15.32V15.33C2,14.47 1,12.85 1,11A5,5 0 0,1 6,6C7,3.65 9.3,2 12,2C15.43,2 18.24,4.66 18.5,8.03L19,8A4,4 0 0,1 23,12C23,13.5 22.2,14.77 21,15.46V15.46C20.5,15.73 19.91,15.57 19.63,15.09C19.36,14.61 19.5,14 20,13.72V13.73C20.6,13.39 21,12.74 21,12A2,2 0 0,0 19,10H17Z" /></svg></label>
               <input type="radio" name="weather" id="weather-storm" value="rainy">
               <label for="weather-storm"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="24" height="24" viewBox="0 0 24 24"><path d="M4.5,13.59C5,13.87 5.14,14.5 4.87,14.96C4.59,15.44 4,15.6 3.5,15.33V15.33C2,14.47 1,12.85 1,11A5,5 0 0,1 6,6C7,3.65 9.3,2 12,2C15.43,2 18.24,4.66 18.5,8.03L19,8A4,4 0 0,1 23,12A4,4 0 0,1 19,16A1,1 0 0,1 18,15A1,1 0 0,1 19,14A2,2 0 0,0 21,12A2,2 0 0,0 19,10H17V9A5,5 0 0,0 12,4C9.5,4 7.45,5.82 7.06,8.19C6.73,8.07 6.37,8 6,8A3,3 0 0,0 3,11C3,12.11 3.6,13.08 4.5,13.6V13.59M9.5,11H12.5L10.5,15H12.5L8.75,22L9.5,17H7L9.5,11M17.5,18.67C17.5,19.96 16.5,21 15.25,21C14,21 13,19.96 13,18.67C13,17.12 15.25,14.5 15.25,14.5C15.25,14.5 17.5,17.12 17.5,18.67Z" /></svg></label>
             <!--</fieldset>
             <fieldset data-role="controlgroup" data-type="horizontal">-->
               <input type="checkbox" name="windy" id="weather-windy" value="windy">
               <label for="weather-windy"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="24" height="24" viewBox="0 0 24 24"><path d="M4,10A1,1 0 0,1 3,9A1,1 0 0,1 4,8H12A2,2 0 0,0 14,6A2,2 0 0,0 12,4C11.45,4 10.95,4.22 10.59,4.59C10.2,5 9.56,5 9.17,4.59C8.78,4.2 8.78,3.56 9.17,3.17C9.9,2.45 10.9,2 12,2A4,4 0 0,1 16,6A4,4 0 0,1 12,10H4M19,12A1,1 0 0,0 20,11A1,1 0 0,0 19,10C18.72,10 18.47,10.11 18.29,10.29C17.9,10.68 17.27,10.68 16.88,10.29C16.5,9.9 16.5,9.27 16.88,8.88C17.42,8.34 18.17,8 19,8A3,3 0 0,1 22,11A3,3 0 0,1 19,14H5A1,1 0 0,1 4,13A1,1 0 0,1 5,12H19M18,18H4A1,1 0 0,1 3,17A1,1 0 0,1 4,16H18A3,3 0 0,1 21,19A3,3 0 0,1 18,22C17.17,22 16.42,21.66 15.88,21.12C15.5,20.73 15.5,20.1 15.88,19.71C16.27,19.32 16.9,19.32 17.29,19.71C17.47,19.89 17.72,20 18,20A1,1 0 0,0 19,19A1,1 0 0,0 18,18Z" /></svg></label>
               <input type="checkbox" name="auto_luces" id="weather-auto_luces" value="auto_luces">
               <label for="weather-auto_luces"><svg height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M10.85 12.65h2.3L12 9l-1.15 3.65zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69zM14.3 16l-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9h-1.9z"/></svg></label>
             </fieldset>
           </form>
         </div>
        </div>
      </div>
      <div id="antipopup">
      </div>
      <div id="svgbasics">
      </div>
    </div>
    <div id="master-controls">
      <span id="botones-trenes"></span>
    </div>
  </div>
  <div id="godown">
  </div>
  <div id="columna-izquierda" class="izquierda">
    <div id="controles-trenes" style="display:none;">
      <!--<h1>Trenes</h1><div><span id="stop-trenes" title="Velocidades a cero"><img src="vel0.svg" width="60" /></span></div>-->
    </div>
    <div id="datos-velocidad">
      <h1>Gr&aacute;ficas</h1>
      <div id="container-graficas"></div>
    </div>
    <div id="chat">
      <h1>Chat</h1>
      <div id="inbox">
      </div>

      <div id="input">
        <form action="/chat/new" method="post" id="messageform">
          <input type="text" name="body" id="message" style="width:15em" autocomplete="off" />
          <input type="submit" value="Enviar" />
          <input type="hidden" name="next" value="/static/test.html" />
        </form>
      </div>
    </div>
    <div id="shells">
      <h1>Comandos especiales</h1>
    </div>
    <div id="tiras">
      <h1>Tiras LED</h1>
      <div id="container-tiras"></div>
    </div>
  </div>
  <!--
  <div id="controles-vias" class="derecha">
    <h1>Vias</h1>
  </div>
  -->
  <div id="parametros" class="derecha">
    <h1>Par&aacute;metros</h1>
    <div id="container-parametros"></div>
  </div>
  <div id="templates" style="display:none">
    <div class="control control-tren">
      <form action="#">
      <div class="estaciones disponibles">
        <h4>Estaciones Disponibles</h4>
        <div class="todas"></div>
      </div>

      <div class="id coloreado"></div>

      <div class="boton_opciones coloreado">
         <svg class="action" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg" onclick="$(this).nextAll('.opciones').toggle();">
            <path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z" fill="none" stroke-width="1.5"/>
         </svg>
         <div class="opciones" style="display:none;"></div>
      </div>

      <div class="auto coloreado"><div class="action auto">AUTO</div><div class="action man">MAN</div></div>

      <div class="estaciones">
        <h4 class="coloreado">Ruta actual</h4>
        <div class="activas"></div>
      </div>


      <!-- <div class="boton-cero"><img src="vel0.svg" width="30" /></div> -->
      <!--
      <div class="velocidad" style="">
        <input name="velocidad" type="number" min="-100" max="100" value="0" />
      </div>
      <select class="clase" name="clase" data-role="none" data-native-menu="false">
        <option value="desconocido">?</option>
        --><!-- Otras opciones via JS --><!--
      </select>
      -->
      <input type="button" name="quitado" class="quitado" style="display:none;" value="OK" data-role="none" />
      <!--
      <div class="alinear_vertical">
      <div class="action invertir ocultable" style="display:none;"></div>
      <div class="control_manual ocultable" style="display:none;"><div class="r action left" v="-20">&lt;</div><div class="f action right" v="20">&gt;</div></div>
      -->
      <!--
      </div>
      <div class="sonidos ocultable" style="display:none;"><ul></ul></div>
      -->
      </form>
    </div>
    <div class="boton-tren">
<svg class="velocimetro" width="125" height="120" aria-label="Velocidad" style="overflow: hidden;" font-family="arial">
  <defs id="defs">
    <mask id="bola">
      <g>
        <rect width="100%" height="100%" fill="white" />
        <circle cx="59.5" cy="59.5" r="54" stroke="black" stroke-width="1" fill="black" />
      </g>
    </mask>
  </defs>
  <g>
    <g class="coloreado action abrir" stroke="#333333" stroke-width="1" fill-opacity="0.7" fill="#333333">
       <circle class="bola"  cx="20"   cy="20"   r="15" mask="url(#bola)" />
       <circle class="borde" cx="59.5" cy="59.5" r="54" />
       <g transform="rotate(-45 17 17)">
         <text class="info id" text-anchor="middle" x="18" y="20" font-size="14" stroke="none" stroke-width="0" fill="white">??</text>
       </g>
    </g>
    <g class="velocidad-input">
       <circle class="esfera" cx="59.5" cy="59.5" r="48" stroke="#e0e0e0" stroke-width="2" fill="#f7f7f7"></circle>
       <!-- Areas aviso -->
       <path class="naranja" d="M100.65 43.162a44 44 0 0 1 1.196 30.435l-10.46-3.4a33 33 0 0 0-.898-22.826z" fill="#f90"/>
       <path class="rojo" d="M101.846 73.597a44 44 0 0 1-10.733 17.516l-7.778-7.778a33 33 0 0 0 8.05-13.137z" fill="#dc3912"/>

       <text class="info clase" text-anchor="middle" x="60" y="46.2" font-size="12" stroke="none" stroke-width="0" fill="#333333">??</text>
       <text class="min" text-anchor="start" x="37.231161645793165" y="84.86883835420683" font-size="6" stroke="none" stroke-width="0" fill="#333333">0</text>
       <text class="max" text-anchor="end" x="82.76883835420686" y="84.8688383542068" font-size="6" stroke="none" stroke-width="0" fill="#333333">100</text>

       <path class="ticksSecundarios" d="M26.235 80.69l-3.75 2.3m-.147-10.753l-4.184 1.36m2.368-10.49l-4.386.345m4.752-9.647l-4.346-.688m11.42-16.393l-3.56-2.587m9.88-4.25l-2.858-3.345m10.598-1.826l-1.998-3.92m10.732.698l-1.028-4.278m19.516 4.278l1.028-4.278m7.706 7.5l1.998-3.92m5.742 9.092l2.858-3.346m3.46 10.182l3.56-2.587m3.516 19.668l4.346-.688m-3.98 9.99l4.386.345m-6.202 8.785l4.184 1.36m-8.08 7.094l3.75 2.3" stroke="#666666" stroke-width="1" fill-opacity="1" fill="none"></path>
       <path class="ticksPrincipales" d="M35.11 84.89l-6.223 6.223M27.48 46.53l-8.13-3.368M60 24.8V16m32.52 30.53l8.13-3.368M84.89 84.89l6.223 6.223" stroke="#333333" stroke-width="2" fill-opacity="1" fill="none"></path>

       <text class="unidad" text-anchor="middle" x="60" y="103" font-size="5" stroke="none" stroke-width="0" fill="#000000">%</text>
       <g class="actual">
         <path class="aguja" style="transform-origin:60px 60px" d="M30.302 89.698c27.52-31.876 37.8-39.98 38.89-38.89 1.09 1.09-7.014 11.37-38.89 38.89" stroke="#c63310" stroke-width="1" fill-opacity="0.7" fill="#dc3912"></path>
         <text class="valor" text-anchor="middle" x="60" y="97.2" font-size="12" stroke="none" stroke-width="0" fill="#000000">0</text>
       </g>
    </g>
    <g class="guardada">
      <!--<circle class="topo" cx="60" cy="60" r="9" stroke="#666666" stroke-width="1" fill="#1654be"></circle>
      <text class="valor" text-anchor="middle" x="60" y="62.5" font-size="9" stroke="none" stroke-width="0" fill="#ffffff">0</text>-->
      <line class="aguja coloreado"  style="transform-origin:60px 60px" x1="55" y1="65" x2="40" y2="80" stroke-dasharray="3 3" stroke-width="3" />
    </g>
    <g class="max">
      <circle class="topo" cx="60" cy="60" r="9" stroke="#666666" stroke-width="1" fill="#1654be"></circle>
      <text class="valor" text-anchor="middle" x="60" y="62.5" font-size="9" stroke="none" stroke-width="0" fill="#ffffff">0</text>
      <line class="aguja"  style="transform-origin:60px 60px" x1="55" y1="65" x2="40" y2="80" stroke="#1654be" />
    </g>
    <g class="coloreado" stroke="#333333" stroke-width="1" fill-opacity="0.7" fill="#333333">
       <g class="action sonido silbato" name="silbato" transform="translate(112 16) scale(1.2)">
       <circle cx="0" cy="0" r="10" />
       <!-- <text font-size="10" stroke-width="0" fill="white" text-anchor="middle" y="3">??</text> -->
<path transform="translate(-6 -7)" d="M13.162,5.345L8.076,0.259c-0.1-0.1-0.252-0.125-0.38-0.064S7.493,0.392,7.508,0.533    c0.004,0.031,0.271,3.15-4.76,8.21c-0.84-0.392-1.74-0.347-2.287,0.201c-0.764,0.764-0.556,2.213,0.462,3.231    s2.468,1.227,3.231,0.463c0.566-0.566,0.598-1.51,0.16-2.375c5.137-5.089,8.482-4.369,8.53-4.358    c0.116,0.028,0.236-0.007,0.317-0.088c0.021-0.021,0.039-0.044,0.055-0.07C13.291,5.615,13.268,5.451,13.162,5.345z M3.682,12.166    c-0.494,0.495-1.542,0.283-2.287-0.462S0.438,9.911,0.932,9.417C1.427,8.922,2.474,9.135,3.219,9.88    C3.964,10.625,4.176,11.672,3.682,12.166z M3.989,9.644l-0.6-0.599C7.088,5.269,7.948,2.538,8.132,1.26l3.934,3.934    C10.669,5.255,7.799,5.924,3.989,9.644z" fill="white" stroke-width="0" />
       </g>
       <g class="action paro_progresivo tren_en_marcha" transform="translate(112 104) scale(1.2)">
       <circle cx="0" cy="0" r="10" />
       <text font-size="7" stroke-width="0" fill="white" text-anchor="middle" y="2.5">STOP</text>
       </g>

       <g class="control_manual tren_parado" transform="translate(112 104) scale(1.2)">
         <!-- Semicirculo r=10 -->
         <path d="M 0,-10 l 0,20 a 10,10 0 0,0 0,-20 " />
         <path transform="rotate(180 0 0)" d="M 0,-10 l 0,20 a 10,10 0 0,0 0,-20 " />
         <!-- Mano -->
         <path transform="translate(-5 -5) scale(0.2)" stroke="white" fill="white"
          d="M52.844,27.116C52.412,26.396,51.689,26,50.805,26c-0.004,0-0.008,0-0.012,0c-1.667,0.006-3.673,0.667-5.235,1.724
	  c-1.441,0.975-3.53,2.782-5.293,5.863c-0.331,0.578-0.874,0.97-1.455,1.063c-0.002-0.134-0.001-0.287-0.001-0.432
	  c0-0.309,0.001-0.677-0.012-1.083V11c0-2.206-1.794-4-4-4s-4,1.794-4,4v15.5c0,0.275-0.225,0.5-0.5,0.5s-0.5-0.225-0.5-0.5V4
	  c0-2.206-1.794-4-4-4s-4,1.794-4,4v22.5c0,0.275-0.225,0.5-0.5,0.5s-0.5-0.225-0.5-0.5v-18c0-1.93-1.57-3.5-3.5-3.5
	  s-3.5,1.57-3.5,3.5v20c0,0.275-0.225,0.5-0.5,0.5s-0.5-0.225-0.5-0.5V16c0-1.93-1.57-3.5-3.51-3.5c-1.93,0-3.5,1.57-3.5,3.5
	  l0.002,27.197c0.968,13.983,9.545,15.869,17.808,15.869c6.846,0,12.995-3.396,16.027-8.824c0.39-0.63,1.445-2.289,2.696-4.254
	  c3.128-4.914,5.748-9.041,6.135-9.775c0.863-1.634,1.826-2.911,2.784-3.693c0.867-0.708,1.397-1.611,1.828-2.404
	  C53.29,29.703,53.484,28.186,52.844,27.116z M51.256,29.259c-0.4,0.729-0.777,1.3-1.282,1.712c-1.18,0.964-2.285,2.413-3.287,4.309
	  c-0.381,0.723-3.794,6.086-6.053,9.635c-1.258,1.976-2.318,3.642-2.733,4.314c-2.701,4.834-8.182,7.838-14.304,7.838
	  c-10.542,0-15.123-4.059-15.81-13.938V16c0-0.827,0.673-1.5,1.51-1.5c0.827,0,1.5,0.673,1.5,1.5v12.5c0,1.379,1.121,2.5,2.5,2.5
	  s2.5-1.121,2.5-2.5v-20c0-0.827,0.673-1.5,1.5-1.5s1.5,0.673,1.5,1.5v18c0,1.379,1.121,2.5,2.5,2.5s2.5-1.121,2.5-2.5V4
	  c0-1.103,0.897-2,2-2s2,0.897,2,2v22.5c0,1.379,1.121,2.5,2.5,2.5s2.5-1.121,2.5-2.5V11c0-1.103,0.897-2,2-2s2,0.897,2,2v22.166
	  c0.013,0.411,0.012,0.758,0.012,1.05c-0.002,0.895-0.003,1.541,0.49,2.024c0.413,0.403,0.948,0.428,1.326,0.432
	  c1.361-0.031,2.655-0.833,3.376-2.092c1.571-2.748,3.41-4.344,4.677-5.199c1.232-0.834,2.851-1.376,4.123-1.381
	  c0.001,0,0.003,0,0.004,0c0.214,0,0.263,0.063,0.292,0.1C51.294,28.35,51.303,28.979,51.256,29.259z"/>
         <!-- Otro semicirculo r=10, para las acciones, transparente -->
         <path class="action f left" v="20" d="M 0,-10 l 0,20 a 10,10 0 0,0 0,-20 " fill-opacity="0" />
         <path class="action r right" v="-20" transform="rotate(180 0 0)" d="M 0,-10 l 0,20 a 10,10 0 0,0 0,-20 " fill-opacity="0" />
       </g>
       <g class="ir_a_setup action" transform="translate(122 60)" onclick="$(this).parents('.boton-tren').addClass('nuevo');">
         <path d="M-3,-10L0,0L-3,10" stroke-width="2" />
       </g>
    </g>
  </g>
</svg>
     <div class="setup">
      <form action="#">
      <div class="coloreado info id"></div>
      <select class="clase" name="clase" data-role="none" data-native-menu="false">
        <option value="desconocido">?</option>
        <!-- Otras opciones via JS -->
      </select>
      <!--
      <input type="button" name="quitado" class="quitado" style="display:none;" value="OK" data-role="none" />
      -->
      <div class="action invertir tren_parado"></div>
      <div class="coloreado control_manual tren_parado"><div class="r action left" v="-20">&lt;</div><div class="f action right" v="20">&gt;</div></div>
      <div class="volver action coloreado" onclick="$(this).parents('.boton-tren').removeClass('nuevo');">
       <svg width="20" height="40">
        <g class="ir_a_velocimetro" transform="translate(18 20)">
         <path d="M-4.5,-15L0,0L-4.5,15Z" stroke-width="1"></path>
        </g>
       </svg>
      </div>
      </form>
     </div>
    </div>
    <!--
    <div class="control control-via">
      <form action="#">
      <div class="boton-cero"><img src="vel0.svg" width="30" /></div>
      <div class="id"></div>
      <div class="velocidad" style="">
        <input name="velocidad" type="number" min="0" max="100" value="0" />
      </div>
      </form>
    </div>
    -->
    <div class="seccion-parametros">
      <form action="#">
        <fieldset class="clase-parametros">
          <legend onclick="$(this).parent().toggleClass('colapsado visible');"></legend>
        </fieldset>
      </form>
    </div>
    <div class="parametro">
      <label></label>
      <p class="doc"></p>
      <input type="number" class="activo" />
      <input type="number" class="default" disabled="disabled" />
    </div>
    <div class="tira">
      <form action="#">
        <fieldset class="fieldset-tira">
          <legend class="desc"></legend>
          <div class="parametro">
            <input type="hidden" name="id" class="id" />
            <select name="imagen" class="imagen" data-role="none">
              <option value="_color1">Color fijo</option>
              <option value="_color2">Degradado</option>
              <option value="__apagar">Apagar</option>
              <option value="__blanco">Blanco</option>
            </select>
            <input type="text" name="color1" class="color color1" data-role="none" />
            <input type="text" name="color2" class="color color2" data-role="none" />
          </parametro>
        </fieldset>
      </form>
    </div>
    <div class="opciones-tren">
       <label></label>
       <input type="checkbox" data-role="none">
    </div>
  </div>
<script>//<![CDATA[
$(function() {
  if (!window.console) window.console = {};
  if (!window.console.log) window.console.log = function() {};

  $.getJSON( "/locomotoras", function( data ) {
    var items = [];
    $.each( data, function( key, val ) {
      items.push( "<option value='" + key + "'>" + val + "</option>" );
    });
    $( items.join( "" ) ).appendTo( "#templates .control-tren select.clase" );
    $( items.join( "" ) ).appendTo( "#templates .boton-tren select.clase" );
  });

  $.getJSON( "/estaciones", function( data ) {
    var items = [];
    $.each( data, function( key, val ) {
      items.push( "<div class='estacion " + key + "' name='" + key + "'>" + val.s + "<div class='action left'></div><div class='action right'></div></div>" );
    });
    $( items.join( "" ) ).appendTo( "#templates .control-tren .estaciones .todas" );
  });

  $.getJSON( "/shell", function( data ) {
    var items = [];
    $.each( data, function( key, val ) {
      items.push( "<div class='shell parametro " + key + "' name='shell" + key + "'><a class='action' onclick='shell("+key+")'>" + val.desc + "</a><div class='hint doc'>"+val.cmdline+"</div></div>" );
    });
    $( items.join( "" ) ).appendTo( "#shells" );
  });

  $.getJSON( "/tira", function( data ) {
    var items = [];
    $.each( data, function( key, val ) {
      items.push( "<option value='" + key + "'>" + key + "</option>" );
    });
    $( items.join( "" ) ).appendTo( "#templates .tira select.imagen" );
  });


  $.getJSON( "/drawing", function( data ) {
    var path = "drawing.svg";
    $.each( data, function( key, val ) {
      if(key=="path") { path = val; console.log("Using drawing path="+path); }
    });
    $('#svgbasics').svg();
    var svg = $('#svgbasics').svg('get');
    svg.load(path, {addTo: false, changeSize: true, onLoad: loadDone});
    $(window).resize(function() {
      resetSize(svg, '100%', $(window).height()-$("#antipopup").height());
    });
  });

  $.getJSON( "/sonidos", function( data ) {
    var base = $("#templates .control-tren .sonidos ul");
    var items = [];
    $.each( data, function( clase, sonidos ) {
      //console.log(clase);
      //console.log(sonidos);
      $.each( sonidos, function( s, file ) {
        var ex = base.find("li."+s).addClass(clase).addClass(clase+"_"+s);
        if(ex.length === 0 && s!="gen") {
          $("<li class='sonido " + clase + " " + s + " " + clase + "_" + s + "' name='" + s + "'>" + s + "</li>").appendTo(base);
        }
      });
    });
  });

  // Añadir boton de invertir en SVG
  $('#templates .boton-tren .invertir').svg();
  var rev = $('#templates .boton-tren .invertir').svg('get');
  rev.load("./uno-reverse.svg", {addTo: false, changeSize: true, onLoad: function () {} });

/*
  $('#templates .control-tren .invertir').svg();
  rev = $('#templates .control-tren .invertir').svg('get');
  rev.load("./uno-reverse.svg", {addTo: false, changeSize: true, onLoad: function () {} });
*/

  // Botones de paro
  // Paro total, parando trenes y quitando tension de las vias despues.
  $('#quitar-tension').click(function() {
    $.get('/tren',{val: 0}, function() { $.get('/via',{val: 0, stop: 'stop'}); });
  });
  // Paro de trenes, y paro en vias, sin quitar tension
  $('#stop').click(function() {
    $.get('/tren',{val: 0}, function() { $.get('/via',{val: 0}); });
  });
  $('#play').click(function() {
    $.get('/tren',{restaurar: 1});
  });
  // Paro de trenes, podria dejar vias con tension
  /*$('#stop-trenes').click(function() {
    $.get('/tren',{val: 0});
  });*/

  // Cierre del popup
  $('#antipopup').on("click",function(evt) {
    if(evt.target == evt.currentTarget) {
      $(".popup").removeClass("popup").appendTo("#controles-trenes");
      /* $("#antipopup").removeClass("show"); */
    }
  });


  // Funcionalidad de chat
  $("#messageform").submit( function() {
      newChatMessage($(this));
      return false;
  });
  $("#messageform").keypress( function(e) {
    if (e.keyCode == 13) {
      newChatMessage($(this));
      return false;
    }
  });

});

function loadDone() {
  var svg = $('#svgbasics').svg('get');
  if(! $("#svgbasics svg").attr("viewBox")) {
      var w = $("#svgbasics svg").attr("width");
      var h = $("#svgbasics svg").attr("height");
      $("#svgbasics svg").attr("viewBox","0 0 "+w+" "+h)/*.attr("width","100%").attr("height","100%")*/;
      resetSize(svg, '100%', $(window).height()-$("#antipopup").height());
  }
  // Agregar el evento de click en los desvios y semaforos
  $('#layer1 > g',svg.root()).on('click',pulsado);
  $('#layer5 > g',svg.root()).on('click',pulsadosemaforo);

  // Eliminar estilo de trazo para poder manipularlo
  $("#layer3 > g > path",svg.root()).css("stroke","")

  // Agregar puntos de agarre en los tramos
  $("#layer3 > g",svg.root()).find("path:first").each(function() {
    var mid  = this.getTotalLength()/2;
    var p    = this.getPointAtLength(mid);
    var prev = this.getPointAtLength(mid*0.99);
    var next = this.getPointAtLength(mid*1.01);
    var delta = { x: next.x - prev.x,  y: next.y - prev.y };
    var angle = Math.atan2(delta.y, delta.x);
    var sizeDelta = Math.sqrt(delta.x ^ 2 + delta.y ^ 2);
    delta.x /= sizeDelta;
    delta.y /= sizeDelta;

    var grupo = svg.group({"transform": "translate("+p.x+","+p.y+")"});
    var rotacionVia = svg.group(grupo,{"transform":"rotate("+(angle*180/Math.PI)+")"});
    var circuloyFlechaTren = svg.group(rotacionVia,{"class":"circuloyflecha"});
    svg.circle(circuloyFlechaTren,0,0,10);
    svg.polygon(circuloyFlechaTren,[[0,10],[30,0],[0,-10]]);
    var accesorios = svg.group(grupo,{"class":"accesorios"});
    svg.text(accesorios,10,-5,"",{"class":"idTren"});
    svg.polygon(accesorios,[[-20,-5],[-10,-5],[-15,-14]]);
    $(this).parent().append(grupo);

    var tenpct = this.getPointAtLength(this.getTotalLength()/8);
    var idVia = svg.text(tenpct.x,tenpct.y,this.parentElement.id,{"class":"idVia","transform":" translate(5,-5)"});
    $(this).parent().append(idVia);
  });

  $("#layer1 > g",svg.root()).find("path:nth-child(2)").each(function() {
    var tran = $(this).parent().find("text").attr("transform");
    var mid  = this.getTotalLength()/2;
    var p    = this.getPointAtLength(mid);
    var m = this.parentElement.transform.baseVal[0].matrix;
    var sigX = m.a>=0?1:-1;
    var sigY = m.d>=0?1:-1;
    console.log(sigX, sigY);
    svg.text(this.parentElement, p.x*sigX, p.y*sigY, this.parentElement.id.replace("desvio",""), {transform: "scale("+sigX+","+sigY+")", "class": "idDesvio"});
  });

  // Buscar tramos y crear controles de vias
  //$("#layer3 > g",svg.root()).each(function () {
  //              var id = this.id;
  //              $( "#templates > .control-via" ).clone().attr("id","control-via-"+id).appendTo("#controles-vias");
  //              var s = $( "#control-via-"+id+" .velocidad input" ).slider({
  //                  stop: function( event, ui ) {
  //                      $.get('/via',{via: id, val: this.value});
  //                  }
  //              });
  //              $( "#control-via-"+id+" .boton-cero" ).click(function() {
  //                  $.get('/via',{via: id, val: 0});
  //                  s.val(0).slider("refresh");
  //              });
  //              $( "#control-via-"+id+" .id" ).html(id);
  //});

  // Agregar evento de click para sacar el popup del tren correspondiente
  $("#layer3 > g").click(function () {
     var id = $(this).attr("idtren");
     if(id) {
         $(".popup").removeClass("popup").appendTo("#controles-trenes");
         /* var len = */ $("#control-tren"+id).addClass("popup").appendTo("#antipopup")/*.length*/;
         /*
         if(len) {
             $("#antipopup").addClass("show");
         }
         */
     }
  });

  // Estaciones
  $("#layer6 > *").hide();

  // Luces
  $("#layer8 > g > *:first-child").hide(); // Ocultamos el primer elemento del grupo, que representa el halo de luz
  $("#layer8 > g").click(function() {
     $.get("/luz",{ id: this.id, estado: !this.estado});
  });

  $(".opciones-weather input").change(function (evt) {
     console.log(evt);
     var partes = evt.target.id.split("-");
     console.log(partes);
     console.log({ id: partes[0], opcion: partes[1], estado: evt.target.checked });
     $.get("/weather",{ id: partes[0], opcion: partes[1], estado: evt.target.checked });
  });

  // Solo empezar el poll cuando el dibujo se haya cargado.
  updater.poll();

}

function pulsado(evt) {
  var d = evt.target.parentElement;
  $.get('/desvio',{ id: d.id.replace("desvio",""), color: (!d.estado?"verde":"rojo")});
}

function pulsadosemaforo(evt) {
  //var d = evt.target.parentElement;
  $.get('/semaforo',{ id: this.id.replace("SEM-","").replace("_"," "), color: (!this.estado?"verde":"rojo")});
}

function newChatMessage(form) {
    var message = form.formToDict();
    var disabled = form.find("input[type=submit]");
    disabled.disable();
    $.postJSON("/chat/new", message, function(response) {
        updater.showMessage(response);
        if (message.id) {
            form.find("input[type=text]").val("");
            form.parent().remove();
        } else {
            form.find("input[type=text]").val("").select();
            disabled.enable();
        }
    });
}

function shell(key) {
  $.get('/shell',{ id: key });
}

jQuery.postJSON = function(url, args, callback) {
    $.ajax({url: url, data: $.param(args), dataType: "text", type: "POST",
            success: function(response) {
        if (callback) callback(eval("(" + response + ")"));
    }, error: function(response) {
        console.log("ERROR:", response)
    }});
};

jQuery.fn.formToDict = function() {
    var fields = this.serializeArray();
    var json = {}
    for (var i = 0; i < fields.length; i++) {
        json[fields[i].name] = fields[i].value;
    }
    if (json.next) delete json.next;
    return json;
};

jQuery.fn.disable = function() {
    this.enable(false);
    return this;
};

jQuery.fn.enable = function(opt_enable) {
    if (arguments.length && !opt_enable) {
        this.attr("disabled", "disabled");
    } else {
        this.removeAttr("disabled");
    }
    return this;
};

$.fn.checked = function(value) {
        if(value === true || value === false) {
            // Set the value of the checkbox
            $(this).each(function(){ this.checked = value; });
        } 
        else if(value === undefined || value === 'toggle') {
            // Toggle the checkbox
            $(this).each(function(){ this.checked = !this.checked; });
        }

        return this;
};

jQuery.fn.boton_repite = function(func, t) {
  var intervalId;
  this.mousedown(function() {
    // https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Operators/this
    // Todo este jaleo para que "this" en la función sea el propio elemento
    var xxx = this;
    xxx.func=func;
    $(this).addClass("pulsado");
    intervalId = setInterval(function() { xxx.func(); }, t);
    xxx.func(); // Llamada una primera vez para que el efecto sea inmediato.
    return false;
  }).on("mouseleave mouseup",function(evt) {
    console.log(evt);
    clearInterval(intervalId);
    $(this).removeClass("pulsado");
    return false;
  }).click(function() {return false;});
  return this; // para que sea encadenable, como habitualmente en jQuery
}

var cumulativeProcessingTime = 0;
var cumulativeIdleTime = 0;
var cumulativeIterations = 0;
var processingSince = 0;
var idleSince = 0;

var updater = {
    errorSleepTime: 500,
    cursor: null,
    cache_trenes: {},
    cache_parametros: {},
    charts: {},

    poll: function() {
        var args = { };
        if (updater.cursor) args.cursor = updater.cursor;
        $.ajax({url: "/update", type: "GET", dataType: "text",
                data: $.param(args),
                success: updater.onSuccess,
                error: updater.onError});
    },

    onSuccess: function(response) {
        if(updater.errorSleepTime >= 15000) {
            // Hace mucho que falla, mejor recargar la página entera
            window.location.reload();
            return;
        }
        try {
            processingSince = performance.now();
            cumulativeIdleTime += processingSince-idleSince;

            updater.newMessages(eval("(" + response + ")"));

            idleSince = performance.now();
            cumulativeProcessingTime += idleSince-processingSince;
            cumulativeIterations ++;
            if ( (cumulativeIterations % 10) == 0 || ((cumulativeProcessingTime + cumulativeIdleTime)>5000) ) {
                $("#processing #bar").css("height",Math.floor(100 * cumulativeProcessingTime / (cumulativeProcessingTime + cumulativeIdleTime))+"%");
                cumulativeProcessingTime = cumulativeIdleTime = 0;
            }

        } catch (e) {
            console.log(e);
            updater.onError();
            return;
        }
        updater.errorSleepTime = 500;
        window.setTimeout(updater.poll, 0);
    },

    onError: function(response) {
        if(updater.errorSleepTime < 10000) {
            updater.errorSleepTime *= 2;
        } else if(updater.errorSleepTime < 20000) {
            updater.errorSleepTime += 500;
        }
        console.log("Poll error; sleeping for ", updater.errorSleepTime, "ms");
        $("#processing").css("background-color","red");
        window.setTimeout(updater.poll, updater.errorSleepTime);
    },

    newMessages: function(response) {
        if (!response.messages) return;
        updater.cursor = response.cursor;
        var messages = response.messages;
        updater.cursor = messages[messages.length - 1].id;
        //console.log(messages.length, "new messages, cursor:", updater.cursor);
        for (var i = 0; i < messages.length; i++) {
            updater.showMessage(messages[i]);
        }
        $("#processing").css("background-color","");
    },

    showMessage: function(message) {
        if (message.deteccion) {
            updater.deteccion(message.deteccion);
        }
        if (message.desvios) {
            updater.desvios(message.desvios);
        }
        if (message.reservas) {
            updater.reservas(message.reservas);
        }
        if (message.semaforos) {
            updater.semaforos(message.semaforos);
        }
        if (message.trenes_eliminados) {
            updater.trenes_eliminados(message.trenes_eliminados);
        }
        if (message.trenes) {
            updater.trenes(message.trenes);
        }
        if (message.velocidades) {
            updater.velocidades(message.velocidades);
        }
        if (message.chat) {
            updater.chatMessage(message.id,message.chat);
        }
        if (message.datos_velocidad) {
            updater.datos_velocidad(message.datos_velocidad);
        }
        if (message.estaciones) {
            updater.estaciones(message.estaciones);
        }
        if (message.luces) {
            updater.luces(message.luces);
        }
        if (message.parametros) {
            updater.parametros(message.parametros);
        }
        if (message.tiras) {
            updater.tiras(message.tiras);
        }
        if (message.weather) {
            updater.weather(message.weather);
        }
    },

    deteccion: function(tramos) {
        for (t in tramos) {
            if(tramos[t]) {
                tren = updater.cache_trenes[tramos[t].id];
                if(!tren) {
                    tren = updater.nuevo_tren(tramos[t].id,tramos[t].clase);
                }
                $('#'+t).attr("tren",tramos[t].clase).attr("idtren",tramos[t].id).attr("estado", tramos[t].estado).attr("invertido",tramos[t].inv).addClass(tren.clase_css).find("text.idTren").html(tramos[t].id);
            } else {
                for (i in updater.clases_disponibles) {
                  $('#'+t).attr("tren","none").removeAttr("idtren").removeAttr("estado").removeAttr("invertido").removeClass(updater.clases_disponibles[i]).find("text.idTren").html("");
                }
            }
        }
    },
    desvios: function(desvios) {
        var svg = $('#svgbasics').svg('get');
        for (var id in desvios) {
            $('#desvio'+id).each( function () {
              if(desvios[id]=="rojo") {
                  this.estado = 0;
              } else {
                  this.estado = 1;
              }

              $('path',this).css('stroke-width','1');
              $('path:nth-of-type('+(this.estado+1)+')',this).css('stroke-width','50');
            });
        }
    },
    reservas: function(desvios) {
        var svg = $('#svgbasics').svg('get');
        for (var id in desvios) {
            $('#desvio'+id).each( function () {
              if(desvios[id]) {
                $('tspan',this).html(desvios[id]);
              } else {
                $('tspan',this).html("");
              }
            });
        }
    },
    semaforos: function(sem) {
        var svg = $('#svgbasics').svg('get');
        for (var id in sem) {
            /* Los topos de colores estan agrupados para separarlos del path que los rodea */
            $('#SEM-'+id.replace(" ","_")+" g").each( function () {
              if(sem[id]=="rojo") {
                  this.parentNode.estado = 0;
              } else {
                  this.parentNode.estado = 1;
              }

              $('path',this).css('visibility','hidden');
              $('path:nth-of-type('+(this.parentNode.estado+1)+')',this).css('visibility','visible');
            })

        }
    },
    luces: function(luz) {
        var svg = $('#svgbasics').svg('get');
        for (var id in luz) {
            $('#'+id).each( function () {
              if(!luz[id]) {
                  this.estado = 0;
                  // El primer hijo del elemento es el halo de luz
                  $('>*:first-child',this).hide();
              } else {
                  this.estado = 1;
                  $('>*:first-child',this).show();
              }
            })
        }
    },
    trenes: function(lista_trenes) {
        var en_pausa = false;

        for (var id in lista_trenes) {
            if(! (id in updater.cache_trenes)) {
                updater.nuevo_tren(id, lista_trenes[id].clase);
            }

            en_pausa |= (lista_trenes[id].v_g != undefined);

            /* Saltar el proceso de un tren que no ha cambiado; guardar el estado para no procesar de nuevo. */
            var x = JSON.stringify(lista_trenes[id]);
            if(updater.cache_trenes[id].tren === x) {
                continue;
            } else {
                updater.cache_trenes[id].tren = x
            }

            updater.cache_trenes[id].selector_clase_boton.val(lista_trenes[id].clase).selectmenu("refresh");
            $( "#boton-tren"+id+" .velocidad").attr("transform","rotate("+lista_trenes[id].velocidad+")");
            $( "#boton-tren"+id+" .v_ef").attr("transform","rotate("+lista_trenes[id].v_ef+")");

            $( "#boton-tren"+id+" .max .aguja").css("transform","rotate("+Math.abs(lista_trenes[id].velocidad*2.7)+"deg)");
            $( "#boton-tren"+id+" .actual .aguja").css("transform","rotate("+Math.abs(lista_trenes[id].v_ef*2.7)+"deg)");
            if(lista_trenes[id].v_g!=undefined) {
               $( "#boton-tren"+id+" .guardada .aguja").css("transform","rotate("+Math.abs(lista_trenes[id].v_g*2.7)+"deg)").show();
            } else {
               $( "#boton-tren"+id+" .guardada .aguja").css("transform","rotate(0deg)").hide();
            }
            $( "#boton-tren"+id+" .max .valor").html(Math.floor(Math.abs(lista_trenes[id].velocidad)));
            $( "#boton-tren"+id+" .actual .valor").html(Math.floor(Math.abs(lista_trenes[id].v_ef)));
            if(lista_trenes[id].velocidad == 0) {
               //console.log("Tren "+id+" parado");
               $( "#boton-tren"+id+" .tren_parado").show();
               $( "#boton-tren"+id+" .tren_en_marcha").hide();
            } else {
               if($( "#boton-tren"+id+" .control_manual .pulsado").length==0) {
                  //console.log("Tren "+id+" en marcha");
                  $( "#boton-tren"+id+" .tren_parado").hide();
                  $( "#boton-tren"+id+" .tren_en_marcha").show();
               }
            }

            $( "#boton-tren"+id+" .info.clase" ).html(lista_trenes[id].clase);
            $("#layer3 > g[idtren='"+id+"']").attr("estado", lista_trenes[id].estado);

            $( "#control-tren"+id+" select.clase, #boton-tren"+id+" select.clase .opcion.seleccionada").removeClass("seleccionada");
            $( "#control-tren"+id+" select.clase, #boton-tren"+id+" select.clase ."+lista_trenes[id].clase).addClass("seleccionada");
            $( "#control-tren"+id+" .sonidos ul li" ).hide();
            $( "#control-tren"+id+" .sonidos ul .gen,."+lista_trenes[id].clase).show();

            $( "#control-tren"+id+" .quitado" ).css("display",lista_trenes[id].estado==5?"":"none");

            /* Saltar el proceso de un tren que no ha cambiado sus estaciones; guardar el estado para no procesar de nuevo. */
            x = JSON.stringify(lista_trenes[id].sta);
            if(updater.cache_trenes[id].sta === x) {
                // Saltar proceso
            } else {
                // Guardar
                updater.cache_trenes[id].sta = x
                // Procesar
                var activas = $( "#control-tren"+id+" .estaciones .activas").empty();
                if(lista_trenes[id].sta) {
                   lista_trenes[id].sta.forEach(function(e,i,a) {
                      var x = $( "#control-tren"+id+" .estaciones .todas").find('[name="'+e.nombre+'"]')
                      //console.log(x);
                      x.clone().addClass(e.sentido).attr("idsta",e.id).click(function () {
                           $.get("/tren",{id: $(this).parents(".control").attr("idtren"), removeSta: $(this).attr("idsta"), sentido: e.sentido });
                           //$(this).remove();
                      }).appendTo(activas[0]);
                   });
                }
            }


            $( "#control-tren"+id+" .auto>.action" ).removeClass("active");
            $( "#control-tren"+id+" .auto>." + (lista_trenes[id].auto?"auto":"man") ).addClass("active");

            /* Saltar el proceso de un tren que no ha cambiado sus estaciones; guardar el estado para no procesar de nuevo. */
            x = JSON.stringify(lista_trenes[id].opciones_activas);
            if(updater.cache_trenes[id].opciones_activas === x) {
                // Saltar proceso
            } else {
                // Guardar
                updater.cache_trenes[id].opciones_activas = x
                // Procesar
                var opciones = $( "#control-tren"+id+" .opciones" ).empty();
                for(var o in lista_trenes[id].opciones_activas) {
                  var v = lista_trenes[id].opciones_activas[o];
                  var opc = $("#templates .opciones-tren").clone();
                  var accion = "<span class='reaccion "+v.opcion.tipo_accion+"'>"+v.opcion.repr+"</span>"
                  for(var c in v.opcion.cuando) {
                     var em = v.opcion.cuando[c].emisor;
                     em = em ? em : "";
                     accion+="<span class='cuando "+v.opcion.cuando[c].tipo_evento+"'>"+em+"</span>";
                  }
                  opc.find("label").attr("for",id+":"+o).append(accion);
                  var input = opc.find("input").attr("name",id+":"+o).attr("id",id+":"+o);
                  if(v.valor) {
                     input.attr("checked","checked").each(function() {this.checked=true;});
                  }
                  opc.appendTo(opciones);
                  input.checkboxradio().change(function (evt) {
                     var partes = evt.target.id.split(":");
                     $.get("/tren",{ id: partes[0], opcion: partes[1], estado: evt.target.checked });
                  });
                };
            }

            // Pintar tren
            spl = lista_trenes[id].tramo.split(" ")
            tramo = spl[0];
            invertido = spl.length>1
            $("[idtren="+id+"]").removeAttr("idtren").removeAttr("estado").removeAttr("invertido").find("text.idTren").html("");
            $('#'+tramo).attr("tren",lista_trenes[id].clase).attr("idtren",id).attr("estado", lista_trenes[id].estado).attr("invertido",invertido).addClass(updater.cache_trenes[id].clase_css).find("text.idTren").html(id);

        }
        for (var id in updater.cache_trenes) {
            if (!(id in lista_trenes)) {
                updater.eliminar_tren(id);
            }
        }
        if(en_pausa) {
               $( "#stop .stop" ).show();
               $( "#stop .pausa" ).hide();
               $( "#play" ).show();
        } else {
               $( "#stop .stop" ).hide();
               $( "#stop .pausa" ).show();
               $( "#play" ).hide();
        }
        //console.log(updater.cache_trenes)
    },
    nuevo_tren: function(id, clase) {
                console.log("Nuevo tren id="+id+" clase="+clase);
                var c = updater.buscar_clase_disponible();

                $( "#templates > .control-tren" ).clone().attr("id","control-tren"+id).attr("idtren",id).addClass(c).appendTo("#controles-trenes");                
                var b = $( "#templates > .boton-tren" ).clone().attr("id","boton-tren"+id).addClass(c).appendTo("#botones-trenes").on("click",".abrir", function() {
                    $(".popup select.clase").selectmenu("destroy");
                    $(".popup").removeClass("popup").appendTo("#controles-trenes").find("select.clase").selectmenu();
                    $("#control-tren"+id+" select.clase").selectmenu("destroy");
                    /*var len = */$("#control-tren"+id).addClass("popup").appendTo("#antipopup")/*.length*/;
                    /*
                    if(len) {
                       $(".popup select.clase").selectmenu()
                       $("#antipopup").addClass("show");
                    }
                    */
                }).on("click", "g.velocidad-input", function(evt) {
                    var r = $(".esfera", this).attr("r");
                    var elementOffset=$(this).offset();
                    //console.log([evt.pageX-elementOffset.left-r, r-(evt.pageY-elementOffset.top)]);
                    var angulo = Math.atan2(evt.pageX-elementOffset.left-r, r-(evt.pageY-elementOffset.top));
                    var v = Math.floor((angulo * 200 / 3 / Math.PI)+50);
                    //console.log(v);
                    v = Math.min(v, 100);
                    v = Math.max(v, 0);
                    $.get('/tren',{id: id, val: v});
                    return false; // No permitir el popup
                }).on("click", ".paro_progresivo", function(evt) {
                    $.get('/tren',{id: id, paro_progresivo: true});
                });
                if(clase=="desconocido") {
                    b.addClass("nuevo");
                }

                var s = $( "#control-tren"+id+" .velocidad input" ).slider({
                    stop: function( event, ui ) {
                        if(this.value*$(this).attr("old") < 0) {
                          $(this).val(0).slider("refresh");
                        }
                        $.get('/tren',{id: id, val: this.value});
                        $(this).attr("old",this.value);
                    }
                }).attr("old",0);

                $( "#control-tren"+id+" .id" ).html(id);

                $( "#control-tren"+id+" .estaciones .todas .estacion .action").click( function() {
                    var sentido = ($(this).hasClass("left")?"ccw":"cw");
                    $.get("/tren",{id: id, addSta: $(this.parentElement).attr("name"), sentido: sentido });
                });
                $( "#control-tren"+id+" .invertir, #boton-tren"+id+" .invertir").click(function() {
                    $.get("/tren",{id: id, invertir: true });
                });
                $( "#boton-tren"+id+" .info.id" ).html(id);
                $( "#boton-tren"+id+" .info.clase" ).html(clase);
                $( "#control-tren"+id+" .quitado" ).click(function() {
                    $.get('/tren',{id: id, quitar: true});
                });

                var cambiar_clase = function () {
                    $.get('/tren',{id: id, clase: this.value});
                }
                var sc_boton = $( "#boton-tren"+id+" select.clase" ).selectmenu().on("change",cambiar_clase);

                $( "#control-tren"+id+" .sonido, #boton-tren"+id+" .sonido").on("click", function() {
                    $.get('/sonidos',{tren: id, sonido: $(this).attr("name")});
                    return false; // Impedir que en el boton haga mas cosas.
                });
                $( "#control-tren"+id+" .control_manual .action, #boton-tren"+id+" .control_manual .action").boton_repite( function() {
                    $.get('/tren',{id: id, manual: true, val: $(this).attr("v")});
                }, 500);
                $( "#control-tren"+id+" .auto>.auto" ).on("click", function() {
                    $.get('/tren',{id: id, auto: true});
                });
                $( "#control-tren"+id+" .auto>.man" ).on("click", function() {
                    $.get('/tren',{id: id, auto: false});
                });

                return updater.cache_trenes[id]={clase_css: c, slider: s, selector_clase_boton: sc_boton }
    },
    trenes_eliminados: function(lista_eliminados) {
       console.log("Trenes eliminados: "+lista_eliminados);
       for (e in lista_eliminados) {
          updater.eliminar_tren(lista_eliminados[e]);
       }
    },
    eliminar_tren: function(id) {
          $( "#control-tren"+id ).remove();
          $( "#boton-tren"+id ).remove();

          delete updater.cache_trenes[id];
    },
    velocidades: function(velocidades_tramos) {
       for (i in velocidades_tramos) {
           var id = i;
           var vel = velocidades_tramos[i];
           //$("#control-via-"+id+" .velocidad input").val(vel.F).slider("refresh"); // TODO: Reverse
           if (vel.stop) {
               //$("#control-via-"+id).addClass("stop");
               $("#"+id).addClass("stop"); // La via en el dibujo
           } else {
               //$("#control-via-"+id).removeClass("stop");
               $("#"+id).removeClass("stop"); // La via en el dibujo
           }
       }
    },
    clases_disponibles: [ "c1", "c2", "c3", "c4", "c5", "c6" ],
    estados_colision_posibles: [ "", "posible", "inminente", "fin", "cerca_fin", "desaparecido", "manual", "frontal" ],
    buscar_clase_disponible: function() {
        var usadas = [];
        for (var c in updater.cache_trenes) usadas[updater.cache_trenes[c].clase_css]=updater.cache_trenes[c].clase_css;
        for (c in updater.clases_disponibles) {
            if (! (updater.clases_disponibles[c] in usadas)) {
                return updater.clases_disponibles[c];
            }
        }
        return undefined;
    },
    chatMessage: function(id,message) {
        var existing = $("#m" + id);
        if (existing.length > 0) return;
        var node = $(message.html || '<div class="message text" id="m'+ id+'">'+message.body+'</div>');
        node.hide();
        $("#inbox").append(node);
        node.slideDown();
    },
    datos_velocidad: function(datos) {
        //console.log(datos);
        var c = updater.charts[datos.tren];
        if(c) {
            c.destroy();
        } else {
            $("<div id='grafica-"+datos.tren+"'></div>").appendTo("#container-graficas");
        }

        var coeffs = datos.coeffs;
        var regresion = [];
        for(var x=1; x<=100; x++) {
           y=0.0
           for (var a in coeffs) {
              //console.log("     "+coeffs[a]+" * "+x+" ^ "+a);
              y += coeffs[a] * Math.pow(x, a);
           }
           regresion.push([x,y]);
        }

        updater.charts[datos.tren] = $.jqplot("grafica-"+datos.tren, [datos.data,regresion,[datos.last]], {
           title: datos.clase+" - "+datos.tren,
           series: [
             { showLine: false, },
             { markerOptions: { size: 0 }, },
             { color: "red", },
           ],
           axes: {
             xaxis: { min: 0, max: 100, tickInterval: 10 },
           },
        })
    },
    estaciones: function(datos) {
        //console.log(datos);
        for (var i in datos) {
            var esta = datos[i];
            if(esta.a) {
                $("#"+i).show();
            } else {
                $("#"+i).hide();
            }
        }
    },
    parametros: function(datos) {
       $( "#container-parametros .seccion-parametros fieldset.visible").each(function() {
          updater.cache_parametros[$(this).parent().parent().attr("id")]=true;
       });
       $( "#container-parametros .seccion-parametros fieldset.colapsado").each(function() {
          updater.cache_parametros[$(this).parent().parent().attr("id")]=false;
       });
       $( "#container-parametros" ).empty();
       for(var seccion in datos) {
          //console.log("Seccion: "+seccion);
          //console.log(datos[seccion]);
          $( "#templates > .seccion-parametros" ).clone().attr("id","seccion-parametros-"+seccion).appendTo("#container-parametros").find("fieldset>legend").html(seccion);
          updater.cache_parametros["seccion-parametros-"+seccion]|=false;
          for(var nombre in datos[seccion]) {
             updater.un_parametro(datos, seccion,nombre);
          }
          if(updater.cache_parametros["seccion-parametros-"+seccion]) {
             $("#seccion-parametros-"+seccion+" fieldset").addClass("visible");
          } else {
             $("#seccion-parametros-"+seccion+" fieldset").addClass("colapsado");
          }
       }
    },
    un_parametro: function(datos, seccion, nombre) {
             var p = $( "#templates > .parametro" ).clone().attr("id","parametro-"+seccion+"-"+nombre).appendTo("#seccion-parametros-"+seccion+" fieldset");
             p.find("label").attr("for",seccion+"/"+nombre).html(nombre);
             if(datos[seccion][nombre].doc) { p.find(".doc").html(datos[seccion][nombre].doc) };
             var input = p.find("input.activo");
             var valor = datos[seccion][nombre].a || datos[seccion][nombre].d;
             input.attr("name", seccion+"/"+nombre);
             input.attr("value", valor);
             var f = function(event, ui) {
                $.get('/parametro',{seccion: seccion, nombre: nombre, val: this.value});
             }
             if(nombre.startsWith("VELOCIDAD") || nombre.startsWith("PORCENTAJE")) {
                input.attr("min",0).attr("max",100);
                input.slider({ stop: f });
             } else {
                input.change(f);
             }
             if(nombre.endsWith("_M")) {
                input.attr("step","0.01");
             }
             if(datos[seccion][nombre].a && (datos[seccion][nombre].a != datos[seccion][nombre].d)) {
                p.addClass("ajustado");
                updater.cache_parametros["seccion-parametros-"+seccion]=true;
             }
             input = p.find("input.default")
             input.attr("name", seccion+"/"+nombre);
             input.attr("value", datos[seccion][nombre].d);
             if(nombre.startsWith("VELOCIDAD") || nombre.startsWith("PORCENTAJE")) {
                input.attr("min",0).attr("max",100).slider();
             }
    },
    tiras: function(datos) {
       $( "#container-tiras select" ).selectmenu("destroy");
       $( "#container-tiras" ).empty();
       for(var tira in datos) {
          console.log("Tira: "+tira);
          console.log(datos[tira]);
          var set_visibility = function (val, fieldset) {
                fieldset.find(".color").parent().hide();
                if( val == "_color1" ) {
                    fieldset.find(".color1").parent().show();
                }
                if( val == "_color2" ) {
                    fieldset.find(".color").parent().show();
                }
          }
          var t = $( "#templates > .tira" ).clone().attr("id","tira-"+tira).appendTo("#container-tiras");
          t.find(".desc").html(datos[tira].desc);
          t.find(".id").val(tira);
          t.find(".color1").val(datos[tira].color1);
          t.find(".color2").val(datos[tira].color2);
          t.find(".imagen").val(datos[tira].imagen).selectmenu().on("change",function () {
                var val = $(this).val();
                var fieldset = $(this).parents("fieldset");
                set_visibility(val, fieldset);
                var id = $(this).parents("fieldset").find(".id").val();
                var c1 = $(this).parents("fieldset").find(".color1").val();
                var c2 = $(this).parents("fieldset").find(".color2").val();
                $.get('/tira',{id: id, imagen: val, color1: c1, color2: c2 });
          });
          t.find(".color").minicolors({control: "brightness", inline:false, changeDelay: 2000, change: function (hex, opacity) {
                var id = $(this).parents("fieldset").find(".id").val();
                var imagen = $(this).parents("fieldset").find("select.imagen").val();
                var c1 = $(this).parents("fieldset").find(".color1").val();
                var c2 = $(this).parents("fieldset").find(".color2").val();
                $.get('/tira',{id: id, imagen: imagen, color1: c1, color2: c2 });
          } });
          set_visibility(datos[tira].imagen, t.find("fieldset") );
       }
    },
    weather: function(datos) {
       for(var opc in datos) {
          console.log(opc);
          console.log(datos[opc]);
          $("#weather-"+opc).checked(datos[opc]);
       }
       $(".opciones-weather input").checkboxradio("refresh");
    },

};

//]]></script>

</body>
</html>
